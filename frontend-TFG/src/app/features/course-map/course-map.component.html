<!-- Auth Warning -->
<div *ngIf="!userId" class="auth-warning">
  <div class="auth-card glass-card">
    <div class="auth-icon">
      <i class="bi bi-person-lock"></i>
    </div>
    <h3>Inicia sesión para continuar</h3>
    <p>Necesitas iniciar sesión para ver y guardar tu progreso en este curso.</p>
    <a routerLink="/login" class="btn-auth">
      <i class="bi bi-box-arrow-in-right"></i>
      Iniciar sesión
    </a>
  </div>
</div>

<!-- Course Content Layout -->
<div *ngIf="userId" class="course-page">
  <!-- Animated Background -->
  <div class="animated-bg">
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
  </div>

  <div class="course-layout">
    <!-- Sidebar -->
    <aside class="course-sidebar glass-card">
      <!-- Course Info Header -->
      <div class="sidebar-header">
        <div class="course-mini-info">
          <h4>{{curso?.title || 'Contenido del Curso'}}</h4>
          <div class="progress-wrapper">
            <div class="progress-bar-container">
              <div class="progress-bar-fill" [style.width.%]="progresoCurso"></div>
            </div>
            <span class="progress-text">{{progresoCurso}}% completado</span>
          </div>
        </div>
      </div>

      <!-- Sections List -->
      <div class="sections-container">
        <div class="sections-list">
          <div *ngFor="let apartado of apartados; let i = index" class="section-item"
            [class.active]="i === selectedIndex" [class.completed]="apartado.completado"
            [class.premium]="apartado.is_premium" [class.locked]="isPremiumLocked(apartado)"
            (click)="selectApartado(i)">

            <div class="section-index">
              <span *ngIf="!apartado.completado">{{i + 1}}</span>
              <i *ngIf="apartado.completado" class="bi bi-check-lg"></i>
            </div>

            <div class="section-info">
              <span class="section-name">{{apartado.nombre}}</span>
              <div class="section-tags">
                <span class="tag tag-premium" *ngIf="apartado.is_premium">
                  <i class="bi bi-gem"></i>
                </span>
                <span class="tag tag-locked" *ngIf="isPremiumLocked(apartado)">
                  <i class="bi bi-lock-fill"></i>
                </span>
              </div>
            </div>
          </div>

          <div *ngIf="apartados.length === 0" class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>No hay apartados disponibles</p>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="content-area">
      <ng-container *ngIf="apartados[selectedIndex] as apartado">

        <!-- Content Header -->
        <div class="content-header glass-card">
          <div class="header-info">
            <div class="header-badges">
              <span class="badge badge-section">Módulo {{selectedIndex + 1}}</span>
              <span class="badge badge-premium" *ngIf="apartado.is_premium">
                <i class="bi bi-gem"></i> Premium
              </span>
              <span class="badge badge-completed" *ngIf="apartado.completado">
                <i class="bi bi-check-circle-fill"></i> Completado
              </span>
            </div>
            <h1 class="content-title">{{apartado.nombre}}</h1>
          </div>

          <div class="header-actions">
            <button *ngIf="!apartado.completado && !isPremiumLocked(apartado)" class="btn-action btn-complete"
              (click)="marcarComoRealizado(selectedIndex)">
              <i class="bi bi-check-circle"></i>
              <span>Marcar completado</span>
            </button>
            <button *ngIf="apartado.completado" class="btn-action btn-repeat"
              (click)="desmarcarComoRealizado(selectedIndex)">
              <i class="bi bi-arrow-repeat"></i>
              <span>Repetir</span>
            </button>
          </div>
        </div>

        <!-- Premium Locked Content -->
        <div *ngIf="isPremiumLocked(apartado)" class="premium-locked glass-card">
          <div class="locked-content">
            <div class="locked-icon">
              <i class="bi bi-gem"></i>
            </div>
            <h2>Contenido Premium</h2>
            <p>Este módulo es exclusivo para usuarios Premium</p>

            <div class="preview-features" *ngIf="apartado.content && apartado.content.length > 0">
              <h4>Lo que incluye:</h4>
              <ul>
                <li *ngFor="let bloque of apartado.content?.slice(0, 3)">
                  <i class="bi" [ngClass]="{
                    'bi-file-text': bloque.tipo === 'texto',
                    'bi-code-square': bloque.tipo === 'codigo',
                    'bi-image': bloque.tipo === 'imagen'
                  }"></i>
                  <span>{{getPreviewText(bloque)}}</span>
                </li>
                <li *ngIf="apartado.content && apartado.content.length > 3">
                  <i class="bi bi-plus-circle"></i>
                  <span>Y {{apartado.content.length - 3}} recursos más...</span>
                </li>
              </ul>
            </div>

            <a routerLink="/pricing" class="btn-upgrade">
              <i class="bi bi-gem"></i>
              <span>Actualizar a Premium</span>
              <i class="bi bi-arrow-right"></i>
            </a>
          </div>
        </div>

        <!-- Regular Content -->
        <div *ngIf="!isPremiumLocked(apartado)" class="content-body">
          <div *ngIf="apartado.content && apartado.content.length" class="content-blocks">
            <div *ngFor="let bloque of apartado.content" class="content-block glass-card">

              <!-- Text Block -->
              <div *ngIf="bloque.tipo === 'texto'" class="block-text">
                <div class="text-content" [innerHTML]="bloque.contenido"></div>
              </div>

              <!-- Code Block -->
              <div *ngIf="bloque.tipo === 'codigo'" class="block-code">
                <div class="code-header">
                  <div class="code-dots">
                    <span></span><span></span><span></span>
                  </div>
                  <span class="code-lang">{{bloque.lenguaje || 'code'}}</span>
                </div>
                <pre class="code-content"><code [innerText]="bloque.contenido"></code></pre>
              </div>

              <!-- Image Block -->
              <div *ngIf="bloque.tipo === 'imagen'" class="block-image">
                <img [src]="bloque.url" [alt]="bloque.descripcion || 'Imagen del curso'" loading="lazy">
                <p *ngIf="bloque.descripcion" class="image-caption">{{bloque.descripcion}}</p>
              </div>
            </div>
          </div>

          <div *ngIf="!apartado.content || !apartado.content.length" class="empty-content glass-card">
            <i class="bi bi-file-earmark-x"></i>
            <h3>Sin contenido</h3>
            <p>No hay contenido disponible para este apartado.</p>
          </div>

          <!-- Navigation -->
          <div class="content-navigation">
            <button class="nav-btn nav-prev" [disabled]="selectedIndex === 0"
              (click)="selectApartado(selectedIndex - 1)">
              <i class="bi bi-arrow-left"></i>
              <span>Anterior</span>
            </button>

            <button class="nav-btn nav-next" [disabled]="selectedIndex === apartados.length - 1"
              (click)="selectApartado(selectedIndex + 1)">
              <span>Siguiente</span>
              <i class="bi bi-arrow-right"></i>
            </button>
          </div>
        </div>
      </ng-container>

      <!-- Error State -->
      <div *ngIf="error" class="error-state glass-card">
        <i class="bi bi-exclamation-triangle"></i>
        <p>{{error}}</p>
      </div>
    </main>
  </div>
</div>