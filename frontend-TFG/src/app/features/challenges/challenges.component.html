<div class="lessons-page">
  <!-- Animated Background Orbs -->
  <div class="animated-bg">
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <div class="gradient-orb orb-3"></div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading">
    <div class="code-loader">
      <span class="bracket">&lt;</span>
      <span class="text">Loading</span>
      <span class="bracket">/&gt;</span>
    </div>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error">
    <div class="error-card glass-card">
      <div class="error-icon">
        <i class="bi bi-bug"></i>
      </div>
      <h3>Error al cargar</h3>
      <p>{{error}}</p>
      <button class="btn-retry" (click)="loadChallenges()">
        <i class="bi bi-arrow-clockwise"></i> Reintentar
      </button>
    </div>
  </div>

  <div class="container" *ngIf="!loading && !error">
    <!-- Hero Section with Search & Filter -->
    <div class="hero-section text-center mb-5">
      <h1 class="page-title">Explora Nuestros <span class="gradient-text">Retos</span></h1>
      <p class="page-subtitle">Pon a prueba tus conocimientos con desafíos prácticos y retos de diferentes niveles.</p>

      <div class="search-filter-container glass-card">
        <div class="search-wrapper">
          <i class="bi bi-search search-icon"></i>
          <input type="text" class="search-input" placeholder="Buscar retos..." [(ngModel)]="searchTerm"
            (ngModelChange)="filterChallenges()">
        </div>
        <div class="filter-wrapper">
          <i class="bi bi-filter-left filter-icon"></i>
          <select class="level-select" [(ngModel)]="selectedLevel" (ngModelChange)="filterChallenges()">
            <option value="">Todos los niveles</option>
            <option value="Principiante">Principiante</option>
            <option value="Intermedio">Intermedio</option>
            <option value="Avanzado">Avanzado</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Challenges Grid -->
    <div class="courses-grid row g-4">
      <div class="col-xl-4 col-lg-6 col-md-6" *ngFor="let challenge of filteredChallenges">
        <div class="course-card glass-card" [class.premium-card]="challenge.is_premium">
          <div class="card-header-img">
            <div class="course-icon-wrapper">
              <i class="bi" [ngClass]="{
                'bi-lightning-charge-fill': challenge.difficulty_level === 'Principiante',
                'bi-puzzle-fill': challenge.difficulty_level === 'Intermedio',
                'bi-trophy-fill': challenge.difficulty_level === 'Avanzado'
              }"></i>
            </div>
            <div class="badges-wrapper">
              <span class="badge badge-type">Reto</span>
              <span *ngIf="challenge.is_premium" class="badge badge-premium">
                <i class="bi bi-gem me-1"></i>Premium
              </span>
            </div>
          </div>

          <div class="card-body">
            <h5 class="course-title">{{challenge.title}}</h5>
            <p class="course-desc lead-text">{{challenge.description}}</p>

            <div class="course-meta">
              <div class="meta-item">
                <span class="level-indicator" [ngClass]="{
                  'level-easy': challenge.difficulty_level === 'Principiante',
                  'level-medium': challenge.difficulty_level === 'Intermedio',
                  'level-hard': challenge.difficulty_level === 'Avanzado'
                }"></span>
                <span class="meta-text">{{challenge.difficulty_level}}</span>
              </div>
              <div class="meta-item">
                <i class="bi bi-calendar3"></i>
                <span class="meta-text">{{ challenge.created_at | date:'shortDate' }}</span>
              </div>
            </div>
          </div>

          <div class="card-footer-actions">
            <ng-container
              *ngIf="!challenge.is_premium || (challenge.is_premium && authService.getCurrentUser()?.plan === 'Premium'); else lockedContent">
              <button class="btn-primary-premium" (click)="startChallenge(challenge.id)">
                <span>Comenzar Reto</span>
                <i class="bi bi-arrow-right"></i>
              </button>
            </ng-container>
            <ng-template #lockedContent>
              <div class="premium-lock-state">
                <div class="lock-info">
                  <i class="bi bi-lock-fill"></i>
                  <span>Contenido Premium</span>
                </div>
                <a routerLink="/user-settings" class="btn-upgrade-premium">
                  <span>Desbloquear</span>
                  <i class="bi bi-gem"></i>
                </a>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty Results -->
    <div *ngIf="filteredChallenges.length === 0" class="empty-results text-center py-5">
      <div class="empty-icon glass-card mb-4">
        <i class="bi bi-journal-x"></i>
      </div>
      <h2>No se encontraron retos</h2>
      <p class="text-muted">Prueba a buscar con otros términos o cambia el nivel.</p>
      <button class="btn-secondary-premium mt-3" (click)="searchTerm = ''; selectedLevel = ''; filterChallenges()">
        Limpiar filtros
      </button>
    </div>
  </div>
</div>

<!-- Modal de detalle de reto -->
<div class="modal fade show d-block" tabindex="-1" *ngIf="showModal"
  style="background:rgba(0,0,0,0.6); backdrop-filter: blur(5px);">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content glass-card">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-puzzle-fill me-2"></i>
          Reto Interactivo
        </h5>
        <button type="button" class="btn-close" aria-label="Cerrar" (click)="closeModal()"></button>
      </div>
      <div class="modal-body">
        <ng-container *ngIf="modalLoading">
          <div class="loading-container" style="min-height: 200px;">
            <div class="code-loader">
              <span class="bracket">&lt;</span>
              <span class="text">Cargando</span>
              <span class="bracket">/&gt;</span>
            </div>
          </div>
        </ng-container>
        <ng-container *ngIf="!modalLoading && modalError">
          <div class="alert alert-danger" role="alert">
            {{ modalError }}
          </div>
        </ng-container>
        <ng-container *ngIf="!modalLoading && !modalError && selectedChallenge">
          <div class="challenge-header-content">
            <h2 class="challenge-title-modal">{{ selectedChallenge.title }}</h2>
            <div class="challenge-badges-modal">
              <span class="badge" [ngClass]="getDifficultyClass(selectedChallenge.difficulty_level)">
                {{ selectedChallenge.difficulty_level }}
              </span>
              <span class="badge bg-secondary">{{ selectedChallenge.language | titlecase }}</span>
            </div>
          </div>

          <p class="challenge-description-modal">{{ selectedChallenge.description }}</p>

          <!-- Hints Section -->
          <div class="hints-section-modal"
            *ngIf="selectedChallenge.hints && (parseHints(selectedChallenge.hints).length > 0)">
            <button class="btn-hint" (click)="showNextHint()"
              [disabled]="currentHint >= parseHints(selectedChallenge.hints).length">
              <i class="bi bi-lightbulb"></i>
              <span>Ver pista ({{currentHint}}/{{parseHints(selectedChallenge.hints).length}})</span>
            </button>
            <div class="hints-container" *ngIf="currentHint > 0">
              <div *ngFor="let hint of parseHints(selectedChallenge.hints).slice(0, currentHint)" class="hint-item">
                <i class="bi bi-info-circle"></i>
                <span>{{ hint }}</span>
              </div>
            </div>
          </div>

          <!-- Code Editor Section -->
          <div class="editor-section-modal">
            <div class="section-label">
              <i class="bi bi-code-slash"></i> Tusolución
            </div>
            <app-code-editor [initialCode]="selectedChallenge.initial_code || ''"
              [language]="selectedChallenge.language || 'javascript'" [isDarkTheme]="true"
              [testCode]="selectedChallenge.test_code || ''">
            </app-code-editor>
          </div>

          <!-- Solution Section -->
          <div class="solution-section-modal mt-4">
            <button class="btn-solution" [class.active]="showSolution" (click)="toggleSolution()">
              <i class="bi" [ngClass]="showSolution ? 'bi-eye-slash' : 'bi-eye'"></i>
              <span>{{ showSolution ? 'Ocultar solución' : 'Ver solución' }}</span>
            </button>

            <div class="solution-wrapper shadow-lg" *ngIf="showSolution">
              <div class="solution-header">
                <i class="bi bi-check-circle-fill"></i>
                <span>Solución Recomendada</span>
              </div>
              <pre class="solution-code"><code>{{ selectedChallenge.solution }}</code></pre>
            </div>
          </div>
        </ng-container>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary-premium" (click)="closeModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<!-- Fin modal -->

<router-outlet></router-outlet>